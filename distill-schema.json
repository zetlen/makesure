{
  "$ref": "#/definitions/DistillConfig",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "definitions": {
    "AstGrepFilterConfig": {
      "additionalProperties": false,
      "description": "Configuration for the ast-grep filter. Extracts AST nodes from source code using ast-grep's pattern syntax. Patterns look like actual code with metavariables ($VAR) for wildcards.",
      "properties": {
        "language": {
          "description": "The language to parse the code as. Required for accurate AST parsing.",
          "type": "string"
        },
        "pattern": {
          "anyOf": [
            {
              "$ref": "#/definitions/AstGrepPatternObject"
            },
            {
              "type": "string"
            }
          ],
          "description": "The pattern to match against. Can be a simple string pattern or an object with context and selector for precise matching."
        },
        "type": {
          "const": "ast-grep",
          "description": "Discriminant tag identifying this as an ast-grep filter.",
          "type": "string"
        }
      },
      "required": ["language", "pattern", "type"],
      "type": "object"
    },
    "AstGrepPatternObject": {
      "additionalProperties": false,
      "description": "Pattern object for ast-grep with context and selector. Used for precise matching within specific AST structures.",
      "properties": {
        "context": {
          "description": "Full code snippet providing context for parsing. This helps ast-grep understand the syntactic structure.",
          "type": "string"
        },
        "selector": {
          "description": "AST node type to select from the matched context. Ensures precise targeting of specific syntax elements.",
          "type": "string"
        }
      },
      "required": ["context", "selector"],
      "type": "object"
    },
    "Check": {
      "additionalProperties": false,
      "description": "A check defines filters to apply and actions to take when changes match.",
      "properties": {
        "actions": {
          "description": "Actions to run when the check is triggered. Will run once per file that matches the check's filters.",
          "items": {
            "anyOf": [
              {
                "additionalProperties": false,
                "description": "A \"report\" action produces a text report about the change. It can be routed many places, including to stdout or an API call (for example, a GitHub comment).",
                "properties": {
                  "template": {
                    "description": "Handlebars template for the comment to produce. Accepts markdown, and receives a FilterResult as its evaluation context.",
                    "type": "string"
                  },
                  "urgency": {
                    "description": "Urgency of report. Higher values indicate more important/urgent reports. Reports are sorted by urgency (highest first) when output.",
                    "type": "number"
                  }
                },
                "required": ["template", "urgency"],
                "type": "object"
              },
              {
                "additionalProperties": false,
                "description": "A \"run\" action runs an arbitrary command that receives details about the change as environment variables.",
                "properties": {
                  "args": {
                    "description": "If the command requires arguments, they can be evaluated here as Handlebars templates which receive a FilterResult as evaluation context.",
                    "items": {
                      "type": "string"
                    },
                    "type": "array"
                  },
                  "command": {
                    "anyOf": [
                      {
                        "type": "string"
                      },
                      {
                        "items": {
                          "type": "string"
                        },
                        "type": "array"
                      }
                    ],
                    "description": "Path to the command. Can be a string or an array of strings which will be evaluated as arguments to produce the command path."
                  },
                  "env": {
                    "additionalProperties": {
                      "type": "string"
                    },
                    "description": "If the default environment variables don't suffice, you can define new ones as Handlebars templates which receive a FilterResult as evaluation context.",
                    "type": "object"
                  }
                },
                "required": ["args", "command", "env"],
                "type": "object"
              }
            ],
            "description": "Union type of all supported actions."
          },
          "type": "array"
        },
        "filters": {
          "description": "Filters to apply to the file content. Each filter processes the file and produces artifacts for comparison. If all filters produce a meaningful diff, the actions are triggered.",
          "items": {
            "$ref": "#/definitions/FilterConfig"
          },
          "type": "array"
        }
      },
      "required": ["actions", "filters"],
      "type": "object"
    },
    "FileCheckset": {
      "additionalProperties": false,
      "description": "Files matching the glob pattern will have the checks applied to them.",
      "properties": {
        "checks": {
          "description": "List of checks to apply to files matching the pattern.",
          "items": {
            "$ref": "#/definitions/Check"
          },
          "type": "array"
        },
        "include": {
          "description": "Glob pattern for files to which this checkset applies. Uses minimatch syntax for pattern matching.",
          "type": "string"
        }
      },
      "required": ["checks", "include"],
      "type": "object"
    },
    "FilterConfig": {
      "anyOf": [
        {
          "$ref": "#/definitions/AstGrepFilterConfig"
        },
        {
          "$ref": "#/definitions/JqFilterConfig"
        },
        {
          "$ref": "#/definitions/RegexFilterConfig"
        },
        {
          "$ref": "#/definitions/TsqFilterConfig"
        },
        {
          "$ref": "#/definitions/XPathFilterConfig"
        }
      ],
      "description": "Union type of all supported filter configurations. Each filter type has its own specific properties with the 'type' field as discriminant."
    },
    "JqFilterConfig": {
      "additionalProperties": false,
      "description": "Configuration for the jq filter. Uses the jq command-line tool to extract/transform JSON content.",
      "properties": {
        "query": {
          "description": "The jq query expression to apply to JSON content. See https://jqlang.github.io/jq/manual/ for syntax reference.",
          "examples": [
            ".version",
            ".dependencies | keys",
            ".scripts | to_entries | map(select(.key | startswith(\"test\")))"
          ],
          "type": "string"
        },
        "type": {
          "const": "jq",
          "description": "Discriminant tag identifying this as a jq filter.",
          "type": "string"
        }
      },
      "required": ["query", "type"],
      "type": "object"
    },
    "DistillConfig": {
      "additionalProperties": false,
      "description": "Root configuration interface for distill.yml files. Defines all the checksets for processing git diffs.",
      "properties": {
        "checksets": {
          "description": "List of file checksets that define how to process different types of files.",
          "items": {
            "$ref": "#/definitions/FileCheckset"
          },
          "type": "array"
        }
      },
      "required": ["checksets"],
      "type": "object"
    },
    "RegexFilterConfig": {
      "additionalProperties": false,
      "description": "Configuration for the regex filter. Extracts content matching a regular expression pattern.",
      "properties": {
        "flags": {
          "description": "Optional regex flags to modify matching behavior. The 'g' (global) and 'm' (multiline) flags are always applied automatically.\n\nCommon flags:\n- 'i': Case-insensitive matching\n- 's': Dot matches newlines (dotAll mode)\n- 'u': Unicode mode",
          "examples": ["i", "iu"],
          "type": "string"
        },
        "pattern": {
          "description": "The regular expression pattern to match. Uses JavaScript regex syntax.",
          "examples": ["API_KEY=.*", "version\\s*=\\s*\\d+\\.\\d+\\.\\d+", "import\\s+\\{[^}]+\\}\\s+from"],
          "type": "string"
        },
        "type": {
          "const": "regex",
          "description": "Discriminant tag identifying this as a regex filter.",
          "type": "string"
        }
      },
      "required": ["pattern", "type"],
      "type": "object"
    },
    "TsqFilterConfig": {
      "additionalProperties": false,
      "description": "Configuration for the tsq (tree-sitter query) filter. Extracts AST nodes from source code using tree-sitter's S-expression query syntax. This enables language-aware code analysis for tracking changes to specific code constructs.",
      "properties": {
        "capture": {
          "description": "Optional capture name to filter results. When specified, only nodes matching this capture name will be extracted. If omitted, all captures from the query will be included.",
          "examples": ["fn", "class-name", "method"],
          "type": "string"
        },
        "language": {
          "$ref": "#/definitions/TsqSupportedExtension",
          "description": "Optional file extension to override language detection. By default, the language is detected from the file being processed. Use this when processing files with non-standard extensions.\n\nSupported extensions: .js, .jsx, .mjs, .ts, .tsx, .py, .go, .java, .rs, .c, .h, .cpp, .cxx, .hpp, .json",
          "examples": [".js", ".py", ".ts"]
        },
        "query": {
          "description": "The tree-sitter query pattern using S-expression syntax. See https://tree-sitter.github.io/tree-sitter/using-parsers/queries for syntax reference.\n\nCommon patterns:\n- `(node_type)",
          "type": "string"
        },
        "type": {
          "const": "tsq",
          "description": "Discriminant tag identifying this as a tsq filter.",
          "type": "string"
        }
      },
      "required": ["query", "type"],
      "type": "object"
    },
    "TsqSupportedExtension": {
      "description": "Supported file extensions for tree-sitter language detection.",
      "enum": [
        ".c",
        ".cpp",
        ".cxx",
        ".go",
        ".h",
        ".hpp",
        ".java",
        ".js",
        ".json",
        ".jsx",
        ".mjs",
        ".py",
        ".rs",
        ".ts",
        ".tsx"
      ],
      "type": "string"
    },
    "XPathFilterConfig": {
      "additionalProperties": false,
      "description": "Configuration for the xpath filter. Extracts nodes from XML/HTML content using XPath expressions.",
      "properties": {
        "expression": {
          "description": "The XPath expression to evaluate against the XML/HTML content. See https://www.w3.org/TR/xpath/ for syntax reference.",
          "examples": ["//version", "//dependency[groupId='com.example']/version", "string(//project/version)"],
          "type": "string"
        },
        "namespaces": {
          "additionalProperties": {
            "type": "string"
          },
          "description": "Optional namespace prefix mappings for XPath expressions. Maps prefix strings to namespace URI strings. Required when querying XML documents with namespaces.",
          "examples": [
            {
              "m": "http://maven.apache.org/POM/4.0.0"
            },
            {
              "svg": "http://www.w3.org/2000/svg",
              "xhtml": "http://www.w3.org/1999/xhtml"
            }
          ],
          "type": "object"
        },
        "type": {
          "const": "xpath",
          "description": "Discriminant tag identifying this as an xpath filter.",
          "type": "string"
        }
      },
      "required": ["expression", "type"],
      "type": "object"
    }
  }
}
