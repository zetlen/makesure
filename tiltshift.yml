# yaml-language-server: $schema=./tiltshift-schema.json

# =============================================================================
# TILTSHIFT CONFIGURATION
# =============================================================================
# This configuration uses the tiltshift structure:
# - subjects: Areas of concern with stakeholders and projections
# - projections: File patterns + focuses (filters) + viewers (actions)
# - defined: Reusable projections, focuses, and viewers
# =============================================================================

subjects:
  # ===========================================================================
  # SECURITY
  # ===========================================================================
  security:
    stakeholders:
      - name: Security Team
        description: Reviews changes for security implications
        contactMethod: security-team@tiltshift.dev

    projections:
      # Runtime dependencies
      - include: 'package.json'
        focuses:
          - type: jq
            query: '.dependencies | del(.workerd)'
        viewers:
          - template: |
              # Runtime dependency changed

              A runtime dependency has changed. Review for security and compatibility.

              ```diff
              {{diffText}}
              ```

      # Docker base image changes
      - include: 'Dockerfile'
        focuses:
          - type: regex
            pattern: '^FROM (?<base_image>.+)$'
        viewers:
          - template: |
              # Docker base image changed

              The base image has changed. Verify compatibility and security.

              ```diff
              {{diffText}}
              ```

      # Docker packages
      - include: 'Dockerfile'
        focuses:
          - type: regex
            pattern: '^RUN apk add (?<packages>.+)$'
        viewers:
          - template: |
              # Docker packages changed

              System packages installed in the container have changed.

              ```diff
              {{diffText}}
              ```

  # ===========================================================================
  # CLI INTERFACE
  # ===========================================================================
  cli-interface:
    stakeholders:
      - name: Product Team
        description: Ensures CLI changes align with product direction and user experience
        contactMethod: ruthless-pm@tiltshift.dev
      - name: Principal Engineer
        description: Reviews CLI changes for adoption impact on large teams
        contactMethod: principal-engineer@tiltshift.dev

    projections:
      # New command detection
      - include: 'src/commands/**/*.ts'
        focuses:
          - type: tsq
            query: |
              (class_declaration
                name: (type_identifier) @name
                (class_heritage
                  (extends_clause
                    value: (identifier) @base_class
                    (#eq? @base_class "BaseCommand")
                  )
                )
              ) @class_decl
            capture: class_decl
        viewers:
          - template: |
              # New CLI command detected

              A new command class has been created.

              ```typescript
              {{diffText}}
              ```

      # Command arguments
      - include: 'src/commands/**/*.ts'
        focuses:
          - type: ast-grep
            language: typescript
            pattern:
              selector: public_field_definition
              context: 'class C { static override args = $ARGS }'
        viewers:
          - template: |
              # CLI command arguments modified

              Command-line arguments have changed. This is a breaking change for users.

              ```diff
              {{diffText}}
              ```

      # Command flags
      - include: 'src/commands/**/*.ts'
        focuses:
          - type: ast-grep
            language: typescript
            pattern:
              selector: public_field_definition
              context: 'class C { static override flags = $FLAGS }'
        viewers:
          - template: |
              # CLI command flags modified

              Command-line flags have changed. This may be a breaking change for users.

              ```diff
              {{diffText}}
              ```

      # Command description
      - include: 'src/commands/**/*.ts'
        focuses:
          - type: ast-grep
            language: typescript
            pattern:
              selector: public_field_definition
              context: 'class C { static override description = $DESC }'
        viewers:
          - template: |
              # CLI command description updated

              ```diff
              {{diffText}}
              ```

  # ===========================================================================
  # PERFORMANCE
  # ===========================================================================
  performance:
    stakeholders:
      - name: Performance Monarch
        description: Evaluates performance implications of changes to focuses and processing
        contactMethod: performance-monarch@tiltshift.dev

    projections:
      # Focus router switch statement
      - include: 'src/lib/focuses/index.ts'
        focuses:
          - type: ast-grep
            language: typescript
            pattern: 'switch ($CONFIG.type) { $$$CASES }'
        viewers:
          - template: |
              # Focus routing logic changed

              The applyFilter switch statement has changed. A focus may have been added or removed.

              ```diff
              {{diffText}}
              ```

      # Focus config type definitions
      - include: 'src/lib/focuses/*.ts'
        focuses:
          - type: tsq
            query: '[(type_alias_declaration name: (type_identifier) @name) @type (interface_declaration name: (type_identifier) @name) @iface]'
        viewers:
          - template: |
              # Focus config type changed

              A focus's configuration type has been modified.

              ```diff
              {{diffText}}
              ```

  # ===========================================================================
  # ARCHITECTURE
  # ===========================================================================
  architecture:
    stakeholders:
      - name: Principal Engineer
        description: Reviews architectural changes for maintainability and scalability
        contactMethod: principal-engineer@tiltshift.dev
      - name: Product Team
        description: Ensures architectural changes support product roadmap
        contactMethod: ruthless-pm@tiltshift.dev

    projections:
      # FocusConfig union type
      - include: 'src/lib/configuration/config.ts'
        focuses:
          - type: tsq
            query: '(type_alias_declaration name: (type_identifier) @name (#eq? @name "FocusConfig")) @decl'
            capture: decl
        viewers:
          - template: |
              # FocusConfig type changed

              The union of supported focus types has changed. Update documentation and schema.

              ```diff
              {{diffText}}
              ```

      # TiltshiftConfig interface
      - include: 'src/lib/configuration/config.ts'
        focuses:
          - type: tsq
            query: '(interface_declaration name: (type_identifier) @name (#eq? @name "TiltshiftConfig")) @decl'
            capture: decl
        viewers:
          - template: |
              # TiltshiftConfig interface changed

              The root configuration interface has changed. Regenerate schema with `npm run generate-schema`.

              ```diff
              {{diffText}}
              ```

      # Projection interface
      - include: 'src/lib/configuration/config.ts'
        focuses:
          - type: tsq
            query: '(interface_declaration name: (type_identifier) @name (#eq? @name "Projection")) @decl'
            capture: decl
        viewers:
          - template: |
              # Projection interface changed

              The Projection interface has changed. This affects how rules are defined.

              ```diff
              {{diffText}}
              ```

  # ===========================================================================
  # BUILD & TOOLING
  # ===========================================================================
  build-tooling:
    stakeholders:
      - name: Dev Team
        description: Maintains build and development tooling
        contactMethod: dev-team@tiltshift.dev

    projections:
      # Dev dependencies
      - include: 'package.json'
        focuses:
          - type: jq
            query: '.devDependencies'
        viewers:
          - template: |
              # Dev dependency changed

              A development dependency has changed.

              ```diff
              {{diffText}}
              ```

      # NPM scripts
      - include: 'package.json'
        focuses:
          - type: jq
            query: '.scripts'
        viewers:
          - template: |
              # NPM scripts modified

              Build/test scripts have changed. Ensure CI/CD pipelines are updated if needed.

              ```diff
              {{diffText}}
              ```

      # Node engine requirement
      - include: 'package.json'
        focuses:
          - type: jq
            query: '.engines'
        viewers:
          - template: |
              # Node.js version requirement changed

              The required Node.js version has changed. Update CI environments and documentation.

              ```diff
              {{diffText}}
              ```

      # oclif configuration
      - include: 'package.json'
        focuses:
          - type: jq
            query: '.oclif'
        viewers:
          - template: |
              # oclif CLI configuration changed

              The oclif plugin/command configuration has changed.

              ```diff
              {{diffText}}
              ```

      # TypeScript compiler options
      - include: 'tsconfig.json'
        focuses:
          - type: jq
            query: '.compilerOptions'
        viewers:
          - template: |
              # TypeScript compiler options changed

              TypeScript configuration has changed. This may affect build output.

              ```diff
              {{diffText}}
              ```

      # Development tool versions
      - include: 'mise.toml'
        focuses:
          - type: regex
            pattern: "\\[tools\\][\\s\\S]+"
            flags: 's'
        viewers:
          - template: |
              # Development tool versions changed

              Tool versions in mise.toml have been updated.

              ```diff
              {{diffText}}
              ```

      # Git hooks configuration
      - include: 'lefthook.yml'
        focuses:
          - type: regex
            pattern: "pre-commit:[\\s\\S]+"
            flags: 's'
        viewers:
          - template: |
              # Git hooks configuration changed

              Pre-commit or other git hooks have been modified.

              ```diff
              {{diffText}}
              ```

  # ===========================================================================
  # DOCUMENTATION
  # ===========================================================================
  documentation:
    stakeholders:
      - name: Doc Team
        description: Maintains documentation
        contactMethod: docs@tiltshift.dev

    projections:
      # README commands section
      - include: 'README.md'
        focuses:
          - type: regex
            pattern: '<!-- commands -->[\\s\\S]+<!-- commandsstop -->'
            flags: 's'
        viewers:
          - template: |
              # README commands section changed

              The auto-generated commands documentation has been updated.

              ```diff
              {{diffText}}
              ```

      # README usage section
      - include: 'README.md'
        focuses:
          - type: regex
            pattern: '<!-- usage -->[\\s\\S]+<!-- usagestop -->'
            flags: 's'
        viewers:
          - template: |
              # README usage section changed

              The usage documentation has been updated.

              ```diff
              {{diffText}}
              ```

      # CLAUDE.md
      - include: 'CLAUDE.md'
        focuses:
          - type: regex
            pattern: "## [\\s\\S]+"
            flags: 's'
        viewers:
          - template: |
              # CLAUDE.md updated

              AI assistant instructions have been modified.

              ```diff
              {{diffText}}
              ```

  # ===========================================================================
  # TESTING
  # ===========================================================================
  testing:
    stakeholders:
      - name: QA Team
        description: Maintains test quality
        contactMethod: qa@tiltshift.dev

    projections:
      # Test fixture configuration
      - include: 'test/fixtures/**/*.yml'
        focuses:
          - type: regex
            pattern: '.*'
            flags: 's'
        viewers:
          - template: |
              # Test fixture configuration changed

              A YAML test fixture has been modified. Verify tests still pass.

              ```diff
              {{diffText}}
              ```

      # JSON Schema
      - include: 'tiltshift-schema.json'
        focuses:
          - type: jq
            query: '.definitions | keys'
        viewers:
          - template: |
              # JSON Schema updated

              The tiltshift configuration schema has changed.

              ```diff
              {{diffText}}
              ```
